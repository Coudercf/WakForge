<template>
  <div class="flex flex-column h-full">
    <div class="characteristic-panels flex pb-3">
      <div class="flex flex-column flex-grow-1 mr-1">
        <div class="category-wrapper flex flex-column">
          <div class="characteristics-category-header px-2 py-2">
            Intelligence - {{ calcRemainingPoints('intelligence') }}/{{ currentCharacter?.characteristics?.limits?.intelligence }} Points
          </div>

          <div class="flex flex-column px-2 py-1">
            <CharacteristicInput
              v-model="percentHealthPoints"
              label="% Health Points"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/1.png"
              :remaining-points="calcRemainingPoints('intelligence')"
              :update-function="updateCharacteristics"
              :step="stepValue"
            />
            <CharacteristicInput
              v-model="intelligenceElementalResistance"
              label="Elemental Resistance"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/116.png"
              :remaining-points="calcRemainingPoints('intelligence')"
              :update-function="updateCharacteristics"
              :max-override="10"
            />
            <CharacteristicInput
              v-model="barrier"
              label="Barrier"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/17.png"
              :remaining-points="calcRemainingPoints('intelligence')"
              :update-function="updateCharacteristics"
              :max-override="10"
            />
            <CharacteristicInput
              v-model="percentHealsReceived"
              label="% Heals Received"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/50.png"
              :remaining-points="calcRemainingPoints('intelligence')"
              :update-function="updateCharacteristics"
              :max-override="5"
            />
            <CharacteristicInput
              v-model="percentArmorHeathPoints"
              label="% Armor Health Points"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/136.png"
              :remaining-points="calcRemainingPoints('intelligence')"
              :update-function="updateCharacteristics"
              :max-override="10"
            />
          </div>
        </div>

        <div class="category-wrapper flex flex-column mt-2">
          <div class="characteristics-category-header px-2 py-2">
            Strength - {{ calcRemainingPoints('strength') }}/{{ currentCharacter?.characteristics?.limits?.strength }} Points
          </div>

          <div class="flex flex-column px-2 py-1">
            <CharacteristicInput
              v-model="elementalMastery"
              label="Elemental Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/223.png"
              :remaining-points="calcRemainingPoints('strength')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="meleeMastery"
              label="Melee Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/226.png"
              :remaining-points="calcRemainingPoints('strength')"
              :update-function="updateCharacteristics"
              :max-override="40"
            />
            <CharacteristicInput
              v-model="distanceMastery"
              label="Distance Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/230.png"
              :remaining-points="calcRemainingPoints('strength')"
              :update-function="updateCharacteristics"
              :max-override="40"
            />
            <CharacteristicInput
              v-model="healthPoints"
              label="Health Points"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/231.png"
              :remaining-points="calcRemainingPoints('strength')"
              :update-function="updateCharacteristics"
            />
          </div>
        </div>

        <div class="category-wrapper flex flex-column mt-2">
          <div class="characteristics-category-header px-2 py-2">
            Agility - {{ calcRemainingPoints('agility') }}/{{ currentCharacter?.characteristics?.limits?.agility }} Points
          </div>

          <div class="flex flex-column px-2 py-1">
            <CharacteristicInput
              v-model="lock"
              label="Lock"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/4.png"
              :remaining-points="calcRemainingPoints('agility')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="dodge"
              label="Dodge"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/3.png"
              :remaining-points="calcRemainingPoints('agility')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="initiative"
              label="Initiative"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/2.png"
              :remaining-points="calcRemainingPoints('agility')"
              :update-function="updateCharacteristics"
              :max-override="20"
            />
            <CharacteristicInput
              v-model="lockAndDodge"
              label="Lock and Dodge"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/121.png"
              :remaining-points="calcRemainingPoints('agility')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="forceOfWill"
              label="Force of Will"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/233.png"
              :remaining-points="calcRemainingPoints('agility')"
              :update-function="updateCharacteristics"
              :max-override="20"
            />
          </div>
        </div>
      </div>

      <div class="flex flex-column flex-grow-1 ml-1">
        <div class="category-wrapper flex flex-column flex-grow-1">
          <div class="characteristics-category-header px-2 py-2">
            Fortune - {{ calcRemainingPoints('fortune') }}/{{ currentCharacter?.characteristics?.limits?.fortune }} Points
          </div>

          <div class="flex flex-column px-2 py-1">
            <CharacteristicInput
              v-model="percentCriticalHit"
              label="% Critical Hit"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/109.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
              :max-override="20"
            />
            <CharacteristicInput
              v-model="percentBlock"
              label="% Block"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/49.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
              :max-override="20"
            />
            <CharacteristicInput
              v-model="criticalMastery"
              label="Critical Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/19.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="rearMastery"
              label="Rear Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/13.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="berserkMastery"
              label="Berserk Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/5.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="healingMastery"
              label="Healing Mastery"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/12.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
            />
            <CharacteristicInput
              v-model="rearResistance"
              label="Rear Resistance"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/115.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
              :max-override="20"
            />
            <CharacteristicInput
              v-model="criticalResistance"
              label="Critical Resistance"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/20.png"
              :remaining-points="calcRemainingPoints('fortune')"
              :update-function="updateCharacteristics"
              :max-override="20"
            />
          </div>
        </div>

        <div class="category-wrapper flex flex-column flex-grow-1 mt-2">
          <div class="characteristics-category-header px-2 py-2">
            Major - {{ calcRemainingPoints('major') }}/{{ currentCharacter?.characteristics?.limits?.major }} Points
          </div>

          <div class="flex flex-column px-2 py-1">
            <CharacteristicInput
              v-model="actionPoints"
              label="Action Points"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/8.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
            />
            <CharacteristicInput
              v-model="movementPointsAndDamage"
              label="Movement Points and Damage"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/16.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
            />
            <CharacteristicInput
              v-model="rangeAndDamage"
              label="Range and Damage"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/48.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
            />
            <CharacteristicInput
              v-model="wakfuPoints"
              label="Wakfu Points"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/105.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
            />
            <CharacteristicInput
              v-model="controlAndDamage"
              label="Control and Damage"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/10.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
            />
            <CharacteristicInput
              v-model="percentDamageInflicted"
              label="% Damage Inflicted"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/52.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
            />
            <CharacteristicInput
              v-model="majorElementalResistance"
              label="Elemental Resistance"
              image-path="https://tmktahu.github.io/WakfuAssets/characteristics/116.png"
              :remaining-points="calcRemainingPoints('major')"
              :update-function="updateCharacteristics"
              :max-override="1"
              :step="stepValue"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- <div class="characteristic-summary mt-2 px-2 py-2"> Summary down here? </div> -->
  </div>
</template>

<script setup>
import { ref, inject, computed, onMounted } from 'vue';

import CharacteristicInput from '@/components/CharacteristicInput.vue';

const currentCharacter = inject('currentCharacter');
const shiftHeld = ref(false);
const stepValue = computed(() => {
  return shiftHeld.value ? 10 : 1;
});

onMounted(() => {
  document.addEventListener('keydown', (event) => {
    handleShiftValue(event);
  });

  document.addEventListener('keyup', (event) => {
    handleShiftValue(event);
  });
});

const handleShiftValue = (event) => {
  if (event.shiftKey) {
    shiftHeld.value = true;
  } else {
    shiftHeld.value = false;
  }
};

// Intelligence vars
const percentHealthPoints = ref(currentCharacter.value.characteristics.intelligence.percentHealthPoints);
const intelligenceElementalResistance = ref(currentCharacter.value.characteristics.intelligence.elementalResistance);
const barrier = ref(currentCharacter.value.characteristics.intelligence.barrier);
const percentHealsReceived = ref(currentCharacter.value.characteristics.intelligence.percentHealsReceived);
const percentArmorHeathPoints = ref(currentCharacter.value.characteristics.intelligence.percentArmorHeathPoints);

// Strength vars
const elementalMastery = ref(currentCharacter.value.characteristics.strength.elementalMastery);
const meleeMastery = ref(currentCharacter.value.characteristics.strength.meleeMastery);
const distanceMastery = ref(currentCharacter.value.characteristics.strength.distanceMastery);
const healthPoints = ref(currentCharacter.value.characteristics.strength.healthPoints);

// Agility vars
const lock = ref(currentCharacter.value.characteristics.agility.lock);
const dodge = ref(currentCharacter.value.characteristics.agility.dodge);
const initiative = ref(currentCharacter.value.characteristics.agility.initiative);
const lockAndDodge = ref(currentCharacter.value.characteristics.agility.lockAndDodge);
const forceOfWill = ref(currentCharacter.value.characteristics.agility.forceOfWill);

// Fortune vars
const percentCriticalHit = ref(currentCharacter.value.characteristics.fortune.percentCriticalHit);
const percentBlock = ref(currentCharacter.value.characteristics.fortune.percentBlock);
const criticalMastery = ref(currentCharacter.value.characteristics.fortune.criticalMastery);
const rearMastery = ref(currentCharacter.value.characteristics.fortune.rearMastery);
const berserkMastery = ref(currentCharacter.value.characteristics.fortune.berserkMastery);
const healingMastery = ref(currentCharacter.value.characteristics.fortune.healingMastery);
const rearResistance = ref(currentCharacter.value.characteristics.fortune.rearResistance);
const criticalResistance = ref(currentCharacter.value.characteristics.fortune.criticalResistance);

// Major vars
const actionPoints = ref(currentCharacter.value.characteristics.major.actionPoints);
const movementPointsAndDamage = ref(currentCharacter.value.characteristics.major.movementPointsAndDamage);
const rangeAndDamage = ref(currentCharacter.value.characteristics.major.rangeAndDamage);
const wakfuPoints = ref(currentCharacter.value.characteristics.major.wakfuPoints);
const controlAndDamage = ref(currentCharacter.value.characteristics.major.controlAndDamage);
const percentDamageInflicted = ref(currentCharacter.value.characteristics.major.percentDamageInflicted);
const majorElementalResistance = ref(currentCharacter.value.characteristics.major.elementalResistance);

const calcRemainingPoints = (type) => {
  let currentTotal = 0;
  if (type === 'intelligence') {
    currentTotal =
      percentHealthPoints.value + intelligenceElementalResistance.value + barrier.value + percentHealsReceived.value + percentArmorHeathPoints.value;
  } else if (type === 'strength') {
    currentTotal = elementalMastery.value + meleeMastery.value + distanceMastery.value + healthPoints.value;
  } else if (type === 'agility') {
    currentTotal = lock.value + dodge.value + initiative.value + lockAndDodge.value + forceOfWill.value;
  } else if (type === 'fortune') {
    currentTotal =
      percentCriticalHit.value +
      percentBlock.value +
      criticalMastery.value +
      rearMastery.value +
      berserkMastery.value +
      healingMastery.value +
      rearResistance.value +
      criticalResistance.value;
  } else if (type === 'major') {
    currentTotal =
      actionPoints.value +
      movementPointsAndDamage.value +
      rangeAndDamage.value +
      wakfuPoints.value +
      controlAndDamage.value +
      percentDamageInflicted.value +
      majorElementalResistance.value;
  }

  return currentCharacter.value.characteristics.limits[type] - currentTotal;
};

const updateCharacteristics = (event) => {
  currentCharacter.value.characteristics.intelligence.percentHealthPoints = percentHealthPoints.value;
  currentCharacter.value.characteristics.intelligence.elementalResistance = intelligenceElementalResistance.value;
  currentCharacter.value.characteristics.intelligence.barrier = barrier.value;
  currentCharacter.value.characteristics.intelligence.percentHealsReceived = percentHealsReceived.value;
  currentCharacter.value.characteristics.intelligence.percentArmorHeathPoints = percentArmorHeathPoints.value;

  currentCharacter.value.characteristics.strength.elementalMastery = elementalMastery.value;
  currentCharacter.value.characteristics.strength.meleeMastery = meleeMastery.value;
  currentCharacter.value.characteristics.strength.distanceMastery = distanceMastery.value;
  currentCharacter.value.characteristics.strength.healthPoints = healthPoints.value;

  currentCharacter.value.characteristics.agility.lock = lock.value;
  currentCharacter.value.characteristics.agility.dodge = dodge.value;
  currentCharacter.value.characteristics.agility.initiative = initiative.value;
  currentCharacter.value.characteristics.agility.lockAndDodge = lockAndDodge.value;
  currentCharacter.value.characteristics.agility.forceOfWill = forceOfWill.value;

  currentCharacter.value.characteristics.fortune.percentCriticalHit = percentCriticalHit.value;
  currentCharacter.value.characteristics.fortune.percentBlock = percentBlock.value;
  currentCharacter.value.characteristics.fortune.criticalMastery = criticalMastery.value;
  currentCharacter.value.characteristics.fortune.rearMastery = rearMastery.value;
  currentCharacter.value.characteristics.fortune.berserkMastery = berserkMastery.value;
  currentCharacter.value.characteristics.fortune.healingMastery = healingMastery.value;
  currentCharacter.value.characteristics.fortune.rearResistance = rearResistance.value;
  currentCharacter.value.characteristics.fortune.criticalResistance = criticalResistance.value;

  currentCharacter.value.characteristics.major.actionPoints = actionPoints.value;
  currentCharacter.value.characteristics.major.movementPointsAndDamage = movementPointsAndDamage.value;
  currentCharacter.value.characteristics.major.rangeAndDamage = rangeAndDamage.value;
  currentCharacter.value.characteristics.major.wakfuPoints = wakfuPoints.value;
  currentCharacter.value.characteristics.major.controlAndDamage = controlAndDamage.value;
  currentCharacter.value.characteristics.major.percentDamageInflicted = percentDamageInflicted.value;
  currentCharacter.value.characteristics.major.elementalResistance = majorElementalResistance.value;
};
</script>

<style lang="scss" scoped>
:deep(.characteristic-panels) {
  .p-panel-header {
    padding: 0 0px 0 10px;
  }

  .category-wrapper {
    border: 1px solid var(--bonta-blue-60);
    border-radius: 8px;
    overflow: hidden;
  }

  .p-inputnumber-button {
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border-radius: 2px;

    span {
      font-size: 12px;
      font-weight: 800;
      color: white;
    }

    &:hover {
      background: var(--bonta-blue-30);

      span {
        font-size: 14px;
        color: var(--bonta-blue-100);
      }
    }
  }
}
.characteristics-category-header {
  font-size: 1rem;
  background-color: var(--bonta-blue-20);
  border-bottom: 1px solid var(--bonta-blue-50);
}

.characteristic-summary {
  display: flex;
  flex-grow: 1;
  border: 1px solid var(--bonta-blue-60);
  border-radius: 8px;
}
</style>
